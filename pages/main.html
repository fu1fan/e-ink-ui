<html>

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./src/bootstrap.min.css">
    <link rel="stylesheet" href="./src/paper.css">
    <title>主界面</title>
</head>

<body>
    <div class="container text-center">
        <div><span id="net"></span>&emsp;<span id="time">00:00</span>&emsp;@xuanzhi33</div>
        <div class="mb-1">
            <button id="refresh">刷新页面</button> <button id="upda">刷新屏幕</button> <button id="getInfo">设备信息</button>
        </div>
        <div class="mb-1">
            <button id="stop">终止程序</button> <button id="poweroff">关闭设备</button> <button id="reboot">重启设备</button>
        </div>
        <div class="mb-1">
            <button id="reader">阅读</button> <button id="weather">天气</button> <button id="clock">大时钟</button> <button
                id="date">小时钟</button>
        </div>
        <div id="result" class="mb-1"></div>
        <input type="text" id="input" class="mb-1">
        <div class="mb-1">
            <button id="dih">&emsp;·&emsp;</button> <button id="backspace">&emsp;←&emsp;</button> <button
                id="next">&emsp;→&emsp;</button> <button id="dah">&emsp;-&emsp;</button>
        </div>
    </div>

    <script src="./src/jquery.min.js"></script>
    <script src="./src/piapi.js"></script>
    <script>
        function upd() {
            piapi.updateImage()
        }

        function updateTime() {
            var date = new Date();
            var h = date.getHours();
            var m = date.getMinutes();
            //auto add 0
            h = h < 10 ? '0' + h : h;
            m = m < 10 ? '0' + m : m;
            var time = h + ":" + m;

            if (time != $("#time").text()) {
                $("#time").text(time);
                upd();
            }
        }

        var date = new Date();
        var h = date.getHours();
        var m = date.getMinutes();
        //auto add 0
        h = h < 10 ? '0' + h : h;
        m = m < 10 ? '0' + m : m;
        var time = h + ":" + m;
        $("#time").text(time);

        setInterval(updateTime, 5000);

        $("#refresh").click(function () {
            location.href = "./main.html?refresh=1";
        });

        $("#upda").click(function () {
            piapi.refreshScreen();
        });

        $("#getInfo").click(function () {
            piapi.log("查询info中")
            piapi.getInfo(function (data) {
                data = JSON.parse(data.data)
                var html = "设备信息<br>";
                for (var i in data) {
                    html += i + "：" + data[i] + "<br>";
                }

                $("#result").html(html);
                setTimeout(upd, 200);
            })
        })
        $("#stop").click(function () {
            piapi.stop()
        })
        $("#poweroff").click(function () {
            piapi.poweroff()
        })
        $("#reboot").click(function () {
            piapi.reboot()
        })
        $("#reader").click(function () {
            location.href = "./reader.html"
        })

        var morseToABC = {
            ".-": "a",
            "-...": "b",
            "-.-.": "c",
            "-..": "d",
            ".": "e",
            "..-.": "f",
            "--.": "g",
            "....": "h",
            "..": "i",
            ".---": "j",
            "-.-": "k",
            ".-..": "l",
            "--": "m",
            "-.": "n",
            "---": "o",
            ".--.": "p",
            "--.-": "q",
            ".-.": "r",
            "...": "s",
            "-": "t",
            "..-": "u",
            "...-": "v",
            ".--": "w",
            "-..-": "x",
            "-.--": "y",
            "--..": "z",
            "-----": "0",
            ".----": "1",
            "..---": "2",
            "...--": "3",
            "....-": "4",
            ".....": "5",
            "-....": "6",
            "--...": "7",
            "---..": "8",
            "----.": "9",
            ".-.-.-": ".",
            "--..--": ",",
            "..--..": "?",
            ".----.": "'",
            "-.-.--": "!",
            "-..-.": "/",
            "-.--.": "(",
            "-.--.-": ")",
            ".-...": "&",
            "---...": ":",
            "-.-.-.": ";",
            "-...-": "=",
            ".-.-.": "+",
            "-....-": "-",
            "..--.-": "_",
            ".-..-.": "@",
            "...-..-": "$",
            ".--.-.": "\"",
            "..--": " ",
            ".-.-": "\n"
        }
        var currentMorse = "";
        var inputId = "input";
        function sendCmd() {
            piapi.runCmd($("#input").val(), function (data) {
                $("#result").html(data.data);
                setTimeout(upd, 200);
            })
            $("#input").val("");
        }
        $("#dih").click(function () {
            currentMorse += ".";
        });
        $("#dah").click(function () {
            currentMorse += "-";
        });
        $("#next").click(function () {
            if (currentMorse == "") {
                $("#" + inputId).val($("#" + inputId).val() + " ");
            } else if (currentMorse == ".-.-") {
                currentMorse = "";
                sendCmd();
            } else {
                var abc = morseToABC[currentMorse];
                if (abc == undefined) {
                    abc = "";
                }
                $("#" + inputId).val($("#" + inputId).val() + abc);
                upd();
                currentMorse = "";
            }
        });
        $("#backspace").click(function () {
            if (currentMorse == "") {
                var val = $("#" + inputId).val();
                $("#" + inputId).val(val.substring(0, val.length - 1));
                upd();
            } else {
                currentMorse = "";
            }
        });

        function GetUrlByParamName(name) {
            var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)");
            var URL = decodeURI(window.location.search);
            var r = URL.substr(1).match(reg);
            if (r != null) {
                //decodeURI() 函数可对 encodeURI() 函数编码过的 URI 进行解码  
                return decodeURI(r[2]);
            };
            return null;
        }

        if (GetUrlByParamName("refresh") == "1") {
            upd();
        }

        function whenOnline() {
            $("#net").html("WiFi");
        }
        function whenOffline() {
            $("#net").html("4G 中国移动");
        }
        if (navigator.onLine) {
            whenOnline();
        } else {
            whenOffline();
        }
        $(window).on("online", function () {
            whenOnline();
            upd();
        });
        $(window).on("offline", function () {
            whenOffline();
            upd();
        });

        $("#clock").click(function () {
            location.href = "./clock.html";
        })
        $("#weather").click(function () {
            location.href = "./weather.html";
        })
        $("#date").click(function () {
            location.href = "./date.html";
        })

        $(window).scroll(upd);
    </script>
</body>

</html>